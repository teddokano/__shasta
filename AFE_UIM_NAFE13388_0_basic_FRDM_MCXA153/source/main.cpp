/*
 *  @author Tedd OKANO
 *
 *  Released under the MIT license
 */

#include	"r01lib.h"
#include	"afe/SPI_for_AFE.h"

SPI				spi( ARD_MOSI, ARD_MISO, ARD_SCK, ARD_CS );	//	MOSI, MISO, SCLK, CS
SPI_for_AFE		dev( spi, 0 );

constexpr uint16_t	CMD_RESET	= 0x14;
constexpr uint16_t	SYS_STATUS	= 0x2B;

constexpr uint16_t	PN2	= 0x40;
constexpr uint16_t	PN1	= 0x41;



constexpr uint16_t	AIO_CONFIG		= 0x1C00 | 0x20;
constexpr uint16_t	AO_CAL_COEF		= 0x1C00 | 0x21;
constexpr uint16_t	AIO_PROT_CFG	= 0x1C00 | 0x22;
constexpr uint16_t	AO_SLR_CTRL		= 0x1C00 | 0x23;
constexpr uint16_t	AWG_PER			= 0x1C00 | 0x24;
constexpr uint16_t	AO_SYSCFG		= 0x1C00 | 0x25;
constexpr uint16_t	AIO_STATUS		= 0x1C00 | 0x26;

constexpr uint16_t	AO_DATA			= 0x1C00 | 0x28;
constexpr uint16_t	AO_OC_POS_LIMIT	= 0x1C00 | 0x29;
constexpr uint16_t	AO_OC_NEG_LIMIT	= 0x1C00 | 0x2A;
constexpr uint16_t	AWG_AMP_MAX		= 0x1C00 | 0x2B;
constexpr uint16_t	AWG_AMP_MIN		= 0x1C00 | 0x2C;


constexpr uint16_t	CMD_AO_ABORT	= 0x1C00 | 0x3;


void tr( uint8_t r0, uint8_t r1, uint8_t d0, uint8_t d1 )
{
	uint16_t	r	= (r0 << 7) | (r1 >> 1);
	uint16_t	d	= (d0 << 8) | (d1 >> 0);
	
	dev.write_r16( r, d );
	
	wait_ms( 2 );
}


int main( void )
{
	printf( "***** Hello, NAFE13388 UIM board! *****\r\n" );

	spi.frequency( 1'000'000 );
	spi.mode( 1 );

	dev.write_r16( CMD_RESET );


	while ( !(dev.read_r16( SYS_STATUS ) & 0x2000) )
		;
	
	printf( "0x%04X\r\n", dev.read_r16( PN2 ) );
	printf( "0x%04X\r\n", dev.read_r16( PN1 ) );

	tr( 0x20, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x40, 0x20, 0x02 );
	tr( 0x38, 0x42, 0x10, 0x00 );
	tr( 0x38, 0x46, 0xAA, 0x00 );
	tr( 0x38, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x4A, 0x0C, 0x00 );
	tr( 0x00, 0x54, 0x00, 0x00 );
	tr( 0x00, 0x60, 0x00, 0x00 );
	dev.write_r24( 0x51, 0x400000 );
	dev.write_r24( 0x59, 0x000000 );

	tr( 0x20, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x40, 0x20, 0x02 );
	tr( 0x38, 0x42, 0x10, 0x00 );
	tr( 0x38, 0x46, 0xAA, 0x00 );
	tr( 0x38, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x4A, 0x0C, 0x00 );
	tr( 0x00, 0x54, 0x00, 0x00 );
	tr( 0x00, 0x60, 0x00, 0x00 );

	tr( 0x20, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x40, 0x20, 0x62 );
	tr( 0x38, 0x42, 0x10, 0x00 );
	tr( 0x38, 0x46, 0xAA, 0x00 );
	tr( 0x38, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x4A, 0x0C, 0x00 );
	tr( 0x00, 0x54, 0x00, 0x00 );
	tr( 0x00, 0x60, 0x00, 0x00 );

	tr( 0x40, 0x80, 0x00, 0x00 );
	dev.write_r24( AO_DATA, 0x614780 );
	
	wait(0.05);

	dev.read_r24( 0x51 );
	dev.read_r24( 0x59 );
	dev.read_r24( AO_DATA );

	tr( 0x20, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x40, 0x20, 0x62 );
	tr( 0x38, 0x42, 0x10, 0x00 );
	tr( 0x38, 0x46, 0xAA, 0x00 );
	tr( 0x38, 0x48, 0x00, 0x00 );
	tr( 0x38, 0x4A, 0x0C, 0x00 );
	tr( 0x00, 0x54, 0x00, 0x00 );
	tr( 0x00, 0x60, 0x00, 0x00 );

	dev.write_r16( 0x10 );

	tr( 0x20, 0x40, 0x00, 0x30 );
	tr( 0x20, 0x42, 0x00, 0xA8 );
	tr( 0x20, 0x44, 0x80, 0xA8 );

//	dev.write_r16( 0x31 );
	while ( true )
	{
		printf( "0x%04X\r\n", dev.read_r16( AIO_STATUS ) );
		wait( 1.0 );
	}

}
